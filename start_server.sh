#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–∏—Å–∫–æ—Ç–µ–∫–∏ –í–î–ù–• –¥–ª—è Ubuntu

echo "üéÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –¥–∏—Å–∫–æ—Ç–µ–∫–∏ –í–î–ù–•"
echo "================================================"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞ (–≤–∞–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –î–û —Ä–∞–±–æ—Ç—ã —Å VPN)
SCRIPT_DIR="$(dirname "$0")"
cd "$SCRIPT_DIR"

# --- üîπ –î–û–ë–ê–í–õ–ï–ù–û: –ø–æ–¥–∫–ª—é—á–∞–µ–º VPN –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞ ---
VPN_NAME="Disco.ovpn"
TEST_HOST="10.8.0.9"  # IP –∞–¥—Ä–µ—Å –≤ VPN —Å–µ—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
MAX_WAIT=30  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

VPN_CONFIG="$SCRIPT_DIR/$VPN_NAME"  # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å

echo "üîå –ü—Ä–æ–≤–µ—Ä—è–µ–º VPN-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ VPN
check_vpn_connectivity() {
    if ping -c 2 -W 3 "$TEST_HOST" >/dev/null 2>&1; then
        return 0  # –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    else
        return 1  # –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ VPN –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –æ–Ω
if openvpn3 sessions-list 2>/dev/null | grep -q "$VPN_NAME"; then
    if check_vpn_connectivity; then
        echo "‚úÖ VPN —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        echo "‚ö†Ô∏è  VPN –∞–∫—Ç–∏–≤–µ–Ω, –Ω–æ —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º..."
        SESSION_PATH=$(openvpn3 sessions-list | grep "$VPN_NAME" -A 1 | grep "Path:" | awk '{print $2}')
        if [ ! -z "$SESSION_PATH" ]; then
            openvpn3 session-manage --session-path "$SESSION_PATH" --disconnect 2>/dev/null
            sleep 3
        fi
        openvpn3 session-start --config "$VPN_CONFIG"
    fi
else
    echo "üåê VPN –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º..."
    openvpn3 session-start --config "$VPN_CONFIG"
fi

# –ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è VPN —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
echo "‚è≥ –û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è VPN..."
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    if check_vpn_connectivity; then
        echo "‚úÖ VPN –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        break
    fi
    sleep 2
    WAITED=$((WAITED + 2))
    echo "   –û–∂–∏–¥–∞–Ω–∏–µ... ($WAITED/$MAX_WAIT —Å–µ–∫)"
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo "‚ö†Ô∏è  VPN –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∑–∞ $MAX_WAIT —Å–µ–∫—É–Ω–¥"
    echo "–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω, –Ω–æ —É–¥–∞–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "VPN-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo ""
    echo "–î–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ VPN:"
    echo "  –ó–∞–ø—É—Å—Ç–∏—Ç—å: openvpn3 session-start --config $VPN_CONFIG"
    echo "  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: ping $TEST_HOST"
    echo ""
fi
# ------------------------------------------------------------

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f "venv/bin/python" ]; then
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo "  sudo bash install_ubuntu.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞
if [ ! -f "scheduler_server.py" ]; then
    echo "‚ùå –§–∞–π–ª scheduler_server.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
if [ ! -f "web_interface.html" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª web_interface.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Hello Kitty –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
echo "================================================"
echo ""

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
source venv/bin/activate
python scheduler_server.py

# –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
deactivate