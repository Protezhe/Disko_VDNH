#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–∏—Å–∫–æ—Ç–µ–∫–∏ –í–î–ù–• –¥–ª—è Ubuntu

echo "üéÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –¥–∏—Å–∫–æ—Ç–µ–∫–∏ –í–î–ù–•"
echo "================================================"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(dirname "$0")"
cd "$SCRIPT_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f "venv/bin/python" ]; then
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo "  sudo bash install_ubuntu.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞
if [ ! -f "scheduler_server.py" ]; then
    echo "‚ùå –§–∞–π–ª scheduler_server.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
if [ ! -f "web_interface.html" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª web_interface.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Hello Kitty –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å..."
echo "================================================"
echo ""

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –≤—ã–≤–æ–¥–∞ SSH —Ç—É–Ω–Ω–µ–ª—è
TUNNEL_LOG=$(mktemp)

# –ó–∞–ø—É—Å–∫–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å –≤ —Ñ–æ–Ω–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤—ã–≤–æ–¥
ssh -R 80:localhost:5002 nokey@localhost.run > "$TUNNEL_LOG" 2>&1 &
SSH_PID=$!

echo "üì° SSH —Ç—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω (PID: $SSH_PID)"
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–∏..."

# –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–∏ (–º–∞–∫—Å–∏–º—É–º 15 —Å–µ–∫—É–Ω–¥)
PUBLIC_URL=""
for i in {1..30}; do
    # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å https:// (localhost.run –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã)
    if grep -q "https://" "$TUNNEL_LOG"; then
        PUBLIC_URL=$(grep -oE "https://[a-zA-Z0-9.-]+(\.lhr\.life|\.localhost\.run)" "$TUNNEL_LOG" | head -n 1)
        if [ -n "$PUBLIC_URL" ]; then
            echo "‚úÖ –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞: $PUBLIC_URL"
            break
        fi
    fi
    sleep 0.5
done

if [ -z "$PUBLIC_URL" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ—ë"
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
echo "================================================"
echo ""

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export PUBLIC_URL="$PUBLIC_URL"

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
source venv/bin/activate
python scheduler_server.py

# –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å
kill $SSH_PID 2>/dev/null

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "$TUNNEL_LOG"

# –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
deactivate