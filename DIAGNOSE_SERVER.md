# Диагностика проблем с сервером на Orange Pi

## Проблема
Сервер вылетает на Orange Pi с Ubuntu с ошибкой "system error report problem" при сохранении настроек расписания или запуске автосаундчека.

## Возможные причины

### 1. Race Condition (Конкуренция потоков)
**Симптомы:** Сервер вылетает при сохранении настроек, особенно когда несколько настроек меняются одновременно.

**Причина:** Несколько потоков одновременно пытаются записать в файл `scheduler_config.json`.

**Решение:** Добавлена синхронизация записи через Lock и атомарная запись через временный файл.

### 2. Поврежденный JSON
**Симптомы:** Сервер не может прочитать конфиг при старте.

**Причина:** Файл был поврежден при одновременной записи из разных потоков.

### 3. Недостаточно памяти
**Симптомы:** Сервер вылетает случайным образом, особенно при запуске саундчека.

**Причина:** Orange Pi имеет ограниченную память, процессы могут быть убиты OOM killer.

### 4. Проблемы с правами доступа
**Симптомы:** Ошибки записи в файлы, "Permission denied".

**Причина:** Недостаточно прав для записи в конфиг или логи.

---

## Шаг 1: Запустить диагностику

На Orange Pi выполните:

```bash
cd /Users/evgeniy/PycharmProjects/Disko_VDNH
source venv/bin/activate
python3 check_server_health.py
```

Этот скрипт проверит:
- Валидность JSON конфига
- Права доступа к файлам
- Свободное место на диске
- Возможность записи в файлы
- Создаст резервную копию конфига

## Шаг 2: Проверить системные логи

```bash
# Смотрим системные ошибки
sudo tail -100 /var/log/syslog | grep -i error

# Смотрим логи systemd (если сервер запущен как сервис)
sudo journalctl -u start_server.sh -n 100 --no-pager

# Проверяем OOM killer (убивает процессы при нехватке памяти)
sudo dmesg | grep -i "killed process"
```

## Шаг 3: Проверить использование ресурсов

```bash
# Память
free -h

# CPU и процессы
top -n 1

# Место на диске
df -h

# Проверить запущен ли сервер
ps aux | grep scheduler_server
```

## Шаг 4: Проверить логи сервера

```bash
# Если сервер запускается в фоне с перенаправлением вывода
cat /path/to/server.log

# Или если используется screen/tmux
screen -r disco_server
# Ctrl+C для выхода без остановки: Ctrl+A, затем D
```

## Шаг 5: Восстановить конфиг из резервной копии (если нужно)

```bash
cd /Users/evgeniy/PycharmProjects/Disko_VDNH

# Проверить наличие резервной копии
ls -lh scheduler_config.json*

# Восстановить из резервной копии
cp scheduler_config.json.backup scheduler_config.json
```

## Шаг 6: Перезапустить сервер с исправлениями

```bash
cd /Users/evgeniy/PycharmProjects/Disko_VDNH
source venv/bin/activate

# Остановить старый сервер (если запущен)
pkill -f scheduler_server.py

# Запустить новый сервер
python3 scheduler_server.py
```

---

## Что было исправлено

### 1. Добавлена синхронизация записи в конфиг
- Используется `threading.Lock()` для предотвращения одновременной записи
- Все методы сохранения теперь используют общий метод `_safe_update_config()`

### 2. Атомарная запись файлов
- Сначала пишем во временный файл `.tmp`
- Потом атомарно заменяем основной файл через `os.replace()`
- Если произойдет ошибка, основной файл не будет поврежден

### 3. Проверка типов данных
- Все числа явно приводятся к нужному типу (int, float, bool)
- Предотвращает ошибки JSON сериализации (NaN, Infinity)

### 4. Улучшенная обработка ошибок
- Временные файлы удаляются при ошибках
- Логирование всех операций записи
- Graceful fallback при ошибках

---

## Как предотвратить проблему в будущем

### 1. Мониторинг ресурсов
```bash
# Установить htop для удобного мониторинга
sudo apt install htop

# Запустить
htop
```

### 2. Регулярные резервные копии
```bash
# Добавить в crontab автоматическое резервное копирование
crontab -e

# Добавить строку (каждый час):
0 * * * * cp /Users/evgeniy/PycharmProjects/Disko_VDNH/scheduler_config.json /Users/evgeniy/PycharmProjects/Disko_VDNH/scheduler_config.json.backup.$(date +\%Y\%m\%d\%H)
```

### 3. Ограничение памяти для саундчека
Если саундчек потребляет много памяти, можно запускать его с ограничениями:
```bash
# В scheduler_server.py можно добавить resource limits
import resource
resource.setrlimit(resource.RLIMIT_AS, (512 * 1024 * 1024, 512 * 1024 * 1024))  # 512MB
```

### 4. Логирование в файл
Перенаправить вывод сервера в файл для анализа:
```bash
python3 scheduler_server.py > server.log 2>&1 &
```

---

## Полезные команды для Orange Pi

```bash
# Проверить температуру CPU
cat /sys/class/thermal/thermal_zone0/temp

# Проверить версию Ubuntu
lsb_release -a

# Проверить архитектуру
uname -m

# Проверить установленные пакеты Python
pip list

# Обновить зависимости
pip install -r requirements.txt --upgrade
```

---

## Контрольный список

- [ ] Запустил check_server_health.py
- [ ] Проверил системные логи
- [ ] Проверил использование памяти и CPU
- [ ] Проверил место на диске
- [ ] Создал резервную копию конфига
- [ ] Обновил код с исправлениями
- [ ] Перезапустил сервер
- [ ] Протестировал сохранение настроек
- [ ] Протестировал запуск автосаундчека
- [ ] Проверил логи после перезапуска

---

## Если проблема продолжается

1. Запустите сервер в debug режиме с полным логированием
2. Соберите логи за период когда происходит вылет
3. Проверьте `/var/log/syslog` на наличие kernel panic или OOM killer
4. Проверьте версии библиотек: `pip list`
5. Попробуйте запустить на другой системе для сравнения

